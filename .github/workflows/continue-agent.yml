name: Continue Agent

'on':
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      instruction:
        description: 'What should the agent improve?'
        required: false
        default: 'Scan the project for potential improvements (code quality, security, performance) and implement them.'

jobs:
  agent:
    if: >-
      (github.event.label.name == 'fix-me' ||
       github.event_name == 'workflow_dispatch' ||
       (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'fix-me'))) &&
      vars.CONTINUE_AGENT_ENABLED == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm install -g @continuedev/cli
          # Add any other dependencies needed for building/testing the project
          # based on the justfile.

      - name: Run Agent
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          INSTRUCTION: ${{ github.event.inputs.instruction }}
        run: |
          # Define the task
          if [ "${{ github.event_name }}" == "issues" ]; then
            TASK="Fix the following issue: $ISSUE_TITLE. Details: $ISSUE_BODY"
          else
            TASK="$INSTRUCTION"
          fi

          echo "Task: $TASK"

          # Configure Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Inject API key into config.json
          if [ -z "$OPENROUTER_API_KEY" ]; then
            echo "Error: OPENROUTER_API_KEY is not set. Please add it to repository secrets."
            exit 1
          fi
          sed -i "s|YOUR_API_KEY|$OPENROUTER_API_KEY|g" .continue/config.json

          # Add a comment to the issue to acknowledge
          if [ "${{ github.event_name }}" == "issues" ]; then
            gh issue comment ${{ github.event.issue.number }} --body "I'm starting to work on this issue! I'll open a pull request shortly."
          fi

          echo "Running Continue Agent to process task..."

          # Run the agent
          # The agent is instructed in config.json to create a branch, commit, and PR.
          npx @continuedev/cli run -p "$TASK"

      - name: Notify Failure
        if: failure() && github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "‚ùå The Continue Agent failed to process this issue. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details."